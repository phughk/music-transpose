<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theory Tool - Composite Rhythms & Chords</title>
    <style>
        :root {
            --bg: #1a1a1a; --card: #2d2d2d; --text: #e0e0e0;
            --accent: #bb86fc; --secondary: #03dac6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 900px; width: 100%; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        input, select, textarea { background: #3d3d3d; border: 1px solid #555; color: white; padding: 6px; border-radius: 4px; }
        button { background: var(--accent); color: black; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .preset-btn { background: #333; color: white; border: 1px solid #555; }
        .preset-btn:hover { background: #555; }
        
        .track-card { background: #1f1f1f; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--secondary); }
        .rhythm-visualizer { display: flex; gap: 3px; margin-top: 15px; flex-wrap: wrap; background: #000; padding: 10px; border-radius: 4px; }
        .beat-cell { width: 22px; height: 22px; border-radius: 2px; font-size: 0.6rem; display: flex; align-items: center; justify-content: center; }
        .on { background: var(--secondary); color: black; box-shadow: 0 0 5px var(--secondary); }
        .off { background: #333; color: #666; }
        .master-off { border: 1px solid #cf6679; opacity: 0.3; }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        
        /* Styles for Chord Matrix */
        .chord-matrix-container { background: #121212; padding: 20px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #bb86fc; }
        .chord-selectors { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .chord-selectors .input-group { flex: 1; min-width: 200px; }
        .chord-selectors select { padding: 10px; font-size: 1rem; }
        .chord-notes-display { background: #1f1f1f; padding: 15px; border-radius: 6px; border: 1px dashed #555; text-align: center; font-size: 1.1rem; }
        .chord-notes-display span.chord-name { color: var(--secondary); font-weight: bold; }
        .chord-notes-display span.chord-spelling { color: #aaa; font-size: 0.9rem; }

        /* Styles for Source Attributions */
        .source-attribution {
            font-size: 0.85rem;
            color: #888;
            margin-top: -10px; /* Pulls it slightly closer to the header */
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .source-attribution a {
            color: var(--secondary);
            text-decoration: none;
            transition: color 0.2s ease, text-shadow 0.2s ease;
        }
        
        .source-attribution a:hover {
            color: var(--accent);
            text-shadow: 0 0 8px rgba(187, 134, 252, 0.4);
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Scale Transposer</h1>
    <p class="source-attribution">Source: <a href="https://en.wikipedia.org/wiki/Mode_(music)#Modern_diatonic_modes">Mode (music), Wikipedia</a></p>
    <div class="row">
        <select id="rootNote" onchange="calculateScale()">
            <option value="0">C</option>
            <option value="1">C#</option>
            <option value="2">D</option>
            <option value="3">D#</option>
            <option value="4">E</option>
            <option value="5">F</option>
            <option value="6">F#</option>
            <option value="7">G</option>
            <option value="8">G#</option>
            <option value="9">A</option>
            <option value="10">A#</option>
            <option value="11">B</option>
        </select>
        <button class="preset-btn" onclick="applyPreset([0, 2, 4, 5, 7, 9, 11])">Ionian (Major)</button>
        <button class="preset-btn" onclick="applyPreset([0, 2, 3, 5, 7, 9, 10])">Dorian</button>
        <button class="preset-btn" onclick="applyPreset([0, 1, 3, 5, 7, 8, 10])">Phrygian</button>
        <button class="preset-btn" onclick="applyPreset([0, 2, 4, 6, 7, 9, 11])">Lydian</button>
        <button class="preset-btn" onclick="applyPreset([0, 2, 4, 5, 7, 9, 10])">Mixolydian</button>
        <button class="preset-btn" onclick="applyPreset([0, 2, 3, 5, 7, 8, 10])">Aeolian (Minor)</button>
        <button class="preset-btn" onclick="applyPreset([0, 1, 3, 5, 6, 8, 10])">Locrian</button>
    </div>
    <div id="scaleDisplay" style="background:#121212; padding:15px; border-radius:8px; font-size: 1.2rem; text-align: center; letter-spacing: 2px;"></div>
</div>

<div class="container">
    <h1>Chord Relationship Matrix</h1>
    <p style="font-size: 0.9rem; color: #aaa;">Select a chord, emotion, or spectrum. Note output adapts to your chosen Transposer Base Note.</p>
    <p class="source-attribution">Source: <a href="https://www.tabletopcomposer.com/post/chord-relationships-and-emotion">Stephen Berkemeier, Tabletop Composer</a></p>
    
    <div class="chord-matrix-container">
        <div class="chord-selectors">
            <div class="input-group">
                <label style="color: var(--accent); font-weight: bold;">Spectrum</label>
                <select id="cr-spectrum" onchange="syncChordData('spectrum')"></select>
            </div>
            
            <div class="input-group">
                <label style="color: var(--secondary); font-weight: bold;">Emotion</label>
                <select id="cr-emotion" onchange="syncChordData('emotion')"></select>
            </div>

            <div class="input-group">
                <label style="color: white; font-weight: bold;">Chord Relationship</label>
                <select id="cr-chord" onchange="syncChordData('chord')"></select>
            </div>
        </div>

        <div id="chordNotesDisplay" class="chord-notes-display">
            </div>
    </div>
</div>

<div class="container">
    <div class="header-row">
        <h1>Composite Rhythm Generator</h1>
        <div class="input-group">
            <label>Global Resolution (Ticks)</label>
            <input type="number" id="globalRes" value="32" style="width: 60px;" oninput="generate()">
        </div>
    </div>

    <h3>1. Master Activators</h3>
    <div id="masterActivators" class="row">
        <input type="text" id="masterInput" value="2/4/0" placeholder="2/4/0 1/8/2">
        <button onclick="generate()">Apply Master</button>
    </div>

    <div class="header-row">
        <h3>2. Beat Tracks</h3>
        <button onclick="addTrack()" style="background: var(--secondary); color: black;">+ Add Track</button>
    </div>
    <div id="tracksContainer"></div>

    <h3>Output Visualizer</h3>
    <div id="rhythmOutput" class="rhythm-visualizer"></div>
</div>

<script>
    const chromatic = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    
    // --- Scale Logic ---
    let intervals = [0, 2, 4, 5, 7, 9, 11];
    function calculateScale() {
        const root = parseInt(document.getElementById('rootNote').value);
        const notes = intervals.map(s => chromatic[(root + s) % 12]);
        document.getElementById('scaleDisplay').innerText = notes.join(" — ");
        calculateChordNotes(); // Update chords whenever root changes
    }
    function applyPreset(arr) { intervals = arr; calculateScale(); }

    // --- Chord Relationship Logic ---
    const crData = [
        { chord: "M III m", emotion: "Sadness", spectrum: "Sad" },
        { chord: "m IV m", emotion: "Tragic", spectrum: "Sad" },
        { chord: "m V m", emotion: "Tragic", spectrum: "Sad" },
        { chord: "m V M", emotion: "Bitter Sweet", spectrum: "Sad" },
        { chord: "m vii M", emotion: "Bitter Sweet", spectrum: "Sad" },
        { chord: "M II m", emotion: "Bitter Sweet", spectrum: "Sad" },
        { chord: "m ii m", emotion: "Mysterious and Tense", spectrum: "Evil Sounding" },
        { chord: "m VII m", emotion: "Mysterious and Tense", spectrum: "Evil Sounding" },
        { chord: "m VI M", emotion: "Mysterious and Tense", spectrum: "Evil Sounding" },
        { chord: "M iii m", emotion: "Mysterious and Tense", spectrum: "Evil Sounding" },
        { chord: "m II m", emotion: "A Little Uneasy", spectrum: "Evil Sounding" },
        { chord: "m vii m", emotion: "A Little Uneasy", spectrum: "Evil Sounding" },
        { chord: "m iii m", emotion: "Otherworldly and Ominous", spectrum: "Evil Sounding" },
        { chord: "m VI m", emotion: "Otherworldly and Ominous", spectrum: "Evil Sounding" },
        { chord: "m III m", emotion: "Ominous and Dark Sounding", spectrum: "Evil Sounding" },
        { chord: "m vi m", emotion: "Ominous and Dark Sounding", spectrum: "Evil Sounding" },
        { chord: "m IV+ m", emotion: "Antagonism and Danger", spectrum: "Evil Sounding" },
        { chord: "m VII M", emotion: "Dramatic", spectrum: "Evil/Neutral Sounding" },
        { chord: "M ii m", emotion: "Dramatic", spectrum: "Evil/Neutral Sounding" },
        { chord: "m II M", emotion: "Mysterious/Dark comedy", spectrum: "Evil/Neutral Sounding" },
        { chord: "M vii m", emotion: "Mysterious/Dark comedy", spectrum: "Evil/Neutral Sounding" },
        { chord: "m IV+ M", emotion: "Outer Space", spectrum: "Evil/Neutral Sounding" },
        { chord: "M IV+ m", emotion: "Outer Space", spectrum: "Evil/Neutral Sounding" },
        { chord: "M ii M", emotion: "Exotic/Cowboy/Enchanted Forest", spectrum: "Neutral Sounding" },
        { chord: "M VII M", emotion: "Exotic/Cowboy/Enchanted Forest", spectrum: "Neutral Sounding" },
        { chord: "M IV+ M", emotion: "Outer Space (Neutral)", spectrum: "Neutral Sounding" },
        { chord: "M VII m", emotion: "Cautious but Optimistic", spectrum: "Neutral Sounding" },
        { chord: "m ii M", emotion: "Cautious but Optimistic", spectrum: "Neutral Sounding" },
        { chord: "m iii M", emotion: "Rising Action/Tension", spectrum: "Neutral Sounding" },
        { chord: "m III M", emotion: "Powerful and Mysterious", spectrum: "Neutral Sounding" },
        { chord: "M vi m", emotion: "Powerful and Mysterious", spectrum: "Neutral Sounding" },
        { chord: "m vi M", emotion: "Resolution", spectrum: "Neutral Sounding" },
        { chord: "M IV m", emotion: "Romantic/Exotic", spectrum: "Good/Neutral Sounding" },
        { chord: "M VI m", emotion: "Other worldly/Heavenly", spectrum: "Good/Neutral Sounding" },
        { chord: "m IV M", emotion: "Wonder and Transcendence", spectrum: "Good/Neutral Sounding" },
        { chord: "M V m", emotion: "Wonder and Transcendence", spectrum: "Good/Neutral Sounding" },
        { chord: "M II M", emotion: "Protagonism", spectrum: "Good Sounding" },
        { chord: "M vii M", emotion: "Protagonism", spectrum: "Good Sounding" },
        { chord: "M iii M", emotion: "Heroic", spectrum: "Good Sounding" },
        { chord: "M VI M", emotion: "Heroic", spectrum: "Good Sounding" },
        { chord: "M III M", emotion: "Fantastical", spectrum: "Good Sounding" },
        { chord: "M vi M", emotion: "Fantastical", spectrum: "Good Sounding" },
        { chord: "M IV M", emotion: "Good Energy", spectrum: "Good Sounding" },
        { chord: "M V M", emotion: "Good Energy", spectrum: "Good Sounding" }
    ];

    // Semitone mapping from Roman Numerals (Image 1)
    const intervalMap = {
        "ii": 1, "II": 2, "iii": 3, "III": 4, "IV": 5, "IV+": 6,
        "V": 7, "vi": 8, "VI": 9, "vii": 10, "VII": 11
    };

    function initChordMatrix() {
        const spectrums = [...new Set(crData.map(item => item.spectrum))];
        const emotions = [...new Set(crData.map(item => item.emotion))];
        const chords = [...new Set(crData.map(item => item.chord))];

        const populateSelect = (id, arr) => {
            const select = document.getElementById(id);
            select.innerHTML = arr.map(val => `<option value="${val}">${val}</option>`).join('');
        };

        populateSelect('cr-spectrum', spectrums);
        populateSelect('cr-emotion', emotions);
        populateSelect('cr-chord', chords);
        
        syncChordData('chord');
    }

    function syncChordData(sourceField) {
        const spectrumSelect = document.getElementById('cr-spectrum');
        const emotionSelect = document.getElementById('cr-emotion');
        const chordSelect = document.getElementById('cr-chord');

        let targetEntry;

        if (sourceField === 'chord') {
            targetEntry = crData.find(item => item.chord === chordSelect.value);
            if (targetEntry) {
                emotionSelect.value = targetEntry.emotion;
                spectrumSelect.value = targetEntry.spectrum;
            }
        } else if (sourceField === 'emotion') {
            targetEntry = crData.find(item => item.emotion === emotionSelect.value);
            if (targetEntry) {
                chordSelect.value = targetEntry.chord;
                spectrumSelect.value = targetEntry.spectrum;
            }
        } else if (sourceField === 'spectrum') {
            targetEntry = crData.find(item => item.spectrum === spectrumSelect.value);
            if (targetEntry) {
                chordSelect.value = targetEntry.chord;
                emotionSelect.value = targetEntry.emotion;
            }
        }
        calculateChordNotes();
    }

    // --- NEW: Calculate Actual Notes ---
    function calculateChordNotes() {
        const rootIndex = parseInt(document.getElementById('rootNote').value);
        const crString = document.getElementById('cr-chord').value;
        if (!crString) return;

        // Parse format (e.g. "m III M")
        const parts = crString.split(' ');
        if (parts.length !== 3) return;

        const q1 = parts[0];       // 'm' or 'M'
        const intSym = parts[1];   // 'III', 'ii', 'IV+', etc.
        const q2 = parts[2];       // 'M' or 'm'

        // Get interval offset from Roman Numeral map
        const semitones = intervalMap[intSym] || 0;

        // Calculate Root Indexes for both chords
        const root1Index = rootIndex;
        const root2Index = (rootIndex + semitones) % 12;

        // Helper to construct a chord
        const buildChord = (rIdx, quality) => {
            const thirdOffset = (quality === 'M') ? 4 : 3;
            const fifthOffset = 7;
            
            const rootNote = chromatic[rIdx];
            const thirdNote = chromatic[(rIdx + thirdOffset) % 12];
            const fifthNote = chromatic[(rIdx + fifthOffset) % 12];
            
            const name = `${rootNote} ${quality === 'M' ? 'Major' : 'minor'}`;
            const spelling = `${rootNote} - ${thirdNote} - ${fifthNote}`;
            return { name, spelling };
        };

        const chord1 = buildChord(root1Index, q1);
        const chord2 = buildChord(root2Index, q2);

        // Render to UI
        document.getElementById('chordNotesDisplay').innerHTML = `
            <span class="chord-name">${chord1.name}</span> <span class="chord-spelling">(${chord1.spelling})</span>
            <span style="margin: 0 15px; color: white;">➔</span>
            <span class="chord-name">${chord2.name}</span> <span class="chord-spelling">(${chord2.spelling})</span>
        `;
    }

    // --- Rhythm Logic (Unchanged) ---
    let tracks = [{ id: Date.now(), period: 4, offset: 0, activators: "1/1/0" }];

    function addTrack() {
        tracks.push({ id: Date.now(), period: 1, offset: 0, activators: "1/1/0" });
        renderTracks();
    }

    function removeTrack(id) {
        tracks = tracks.filter(t => t.id !== id);
        renderTracks();
    }

    function updateTrack(id, field, value) {
        const track = tracks.find(t => t.id === id);
        track[field] = value;
        generate();
    }

    function renderTracks() {
        const container = document.getElementById('tracksContainer');
        container.innerHTML = '';
        tracks.forEach(t => {
            const div = document.createElement('div');
            div.className = 'track-card';
            div.innerHTML = `
                <div class="row">
                    <div class="input-group"><label>Period</label><input type="number" value="${t.period}" oninput="updateTrack(${t.id}, 'period', parseInt(this.value))" style="width:50px"></div>
                    <div class="input-group"><label>Offset</label><input type="number" value="${t.offset}" oninput="updateTrack(${t.id}, 'offset', parseInt(this.value))" style="width:50px"></div>
                    <div class="input-group"><label>Track Activators</label><input type="text" value="${t.activators}" oninput="updateTrack(${t.id}, 'activators', this.value)" style="width:200px"></div>
                    <button onclick="removeTrack(${t.id})" style="background:#cf6679">×</button>
                </div>
            `;
            container.appendChild(div);
        });
        generate();
    }

    function checkActivator(tick, str) {
        if (!str.trim()) return true;
        const cycles = str.trim().split(/\s+/);
        return cycles.every(c => {
            const parts = c.split('/');
            if(parts.length < 2) return true;
            const on = Number(parts[0]);
            const total = Number(parts[1]);
            const offset = Number(parts[2]) || 0;
            const pos = (tick + offset) % total;
            return pos < on;
        });
    }

    function generate() {
        const res = parseInt(document.getElementById('globalRes').value);
        const masterStr = document.getElementById('masterInput').value;
        const output = document.getElementById('rhythmOutput');
        output.innerHTML = '';

        for (let i = 0; i < res; i++) {
            const isMasterOn = checkActivator(i, masterStr);
            let isNoteTriggered = false;

            tracks.forEach(t => {
                if ((i - t.offset) % t.period === 0 && i >= t.offset) {
                    if (checkActivator(i, t.activators)) {
                        isNoteTriggered = true;
                    }
                }
            });

            const active = isMasterOn && isNoteTriggered;
            const cell = document.createElement('div');
            cell.className = `beat-cell ${active ? 'on' : 'off'} ${!isMasterOn ? 'master-off' : ''}`;
            cell.innerText = i;
            output.appendChild(cell);
        }
    }

    // Init
    calculateScale();
    initChordMatrix();
    renderTracks();
</script>
</body>
</html>
