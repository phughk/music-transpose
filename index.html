<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theory Tool - Composite Rhythms & Chords</title>
    <style>
        :root {
            --bg: #1a1a1a; --card: #2d2d2d; --text: #e0e0e0;
            --accent: #bb86fc; --secondary: #03dac6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 900px; width: 100%; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        input, select, textarea { background: #3d3d3d; border: 1px solid #555; color: white; padding: 6px; border-radius: 4px; }
        button { background: var(--accent); color: black; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .preset-btn { background: #333; color: white; border: 1px solid #555; }
        .preset-btn:hover { background: #555; }
        
        .track-card { background: #1f1f1f; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--secondary); }
        
        /* Styles for Chord Matrix */
        .chord-matrix-container { background: #121212; padding: 20px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #bb86fc; }
        .chord-selectors { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .chord-selectors .input-group { flex: 1; min-width: 200px; }
        .chord-selectors select { padding: 10px; font-size: 1rem; }
        .chord-notes-display { background: #1f1f1f; padding: 15px; border-radius: 6px; border: 1px dashed #555; text-align: center; font-size: 1.1rem; }
        .chord-notes-display span.chord-name { color: var(--secondary); font-weight: bold; }
        .chord-notes-display span.chord-spelling { color: #aaa; font-size: 0.9rem; }

        /* Styles for Source Attributions */
        .source-attribution { font-size: 0.85rem; color: #888; margin-top: -10px; margin-bottom: 20px; font-style: italic; }
        .source-attribution a { color: var(--secondary); text-decoration: none; transition: color 0.2s ease, text-shadow 0.2s ease; }
        .source-attribution a:hover { color: var(--accent); text-shadow: 0 0 8px rgba(187, 134, 252, 0.4); text-decoration: underline; }

        /* Step Sequencer Styles */
        .sequencer-grid { display: flex; flex-direction: column; gap: 4px; margin-top: 15px; overflow-x: auto; padding: 10px; background: #000; border-radius: 8px; }
        .seq-row { display: flex; gap: 4px; align-items: center; }
        .seq-label { width: 45px; font-size: 0.8rem; font-weight: bold; color: var(--secondary); text-align: right; padding-right: 8px; flex-shrink: 0; }
        .seq-cell { width: 22px; height: 22px; border-radius: 2px; background: #222; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #555; flex-shrink: 0; transition: background 0.1s; }
        .seq-cell.on { background: var(--secondary); color: black; box-shadow: 0 0 8px var(--secondary); }
        .seq-cell.master-off { border: 1px solid #cf6679; background: transparent; opacity: 0.2; color: transparent; }
        
        /* Playhead Highlights */
        .seq-cell.playing { outline: 2px solid white; transform: scale(1.15); z-index: 10; background: #fff; box-shadow: 0 0 15px white; }
        .tick-label.playing { color: white; font-weight: bold; transform: scale(1.2); }

        .tick-ruler { display: flex; gap: 4px; margin-left: 53px; margin-bottom: 5px; }
        .tick-label { width: 22px; text-align: center; font-size: 0.6rem; color: #777; flex-shrink: 0; transition: color 0.1s; }

        .instructions { background: #222; border-left: 4px solid var(--accent); padding: 15px; margin-bottom: 25px; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; }
        .instructions ul { margin-top: 8px; margin-bottom: 0; padding-left: 20px; }
        .instructions li { margin-bottom: 6px; }

        .play-controls { display: flex; gap: 15px; align-items: flex-end; background: #1f1f1f; padding: 10px 20px; border-radius: 8px; border: 1px solid #444; }
        
        /* Specific input sizing */
        .num-sm { width: 50px; text-align: center; }
        .num-md { width: 60px; text-align: center; }

        /* Time Signature Visualizer Styles */
        .rhythm-visualizer { display: flex; flex-wrap: wrap; margin-top: 20px; align-items: center; }
        .rhythm-group { display: flex; gap: 6px; margin-right: 20px; margin-bottom: 10px; background: #1f1f1f; padding: 10px; border-radius: 8px; border-bottom: 3px solid #444; }
        .rhythm-block { width: 45px; height: 45px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: bold; color: #888; transition: 0.2s; border: 2px solid transparent; }
        .rhythm-block.accent { background: rgba(187, 134, 252, 0.15); color: var(--accent); border-color: var(--accent); transform: scale(1.1); box-shadow: 0 0 15px rgba(187, 134, 252, 0.3); }

        /* Styles for Chord Dictionary Visualizer */
    /* Styles for Chord Dictionary Visualizer */
        .chord-visualizer { 
            display: flex; 
            gap: 4px; /* Tighter gap for small screens */
            margin-top: 15px; 
            background: #000; 
            padding: 20px 10px; 
            border-radius: 8px; 
            justify-content: space-between; 
            width: 100%;
            box-sizing: border-box;
        }
        .chord-col { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 10px; 
            flex: 1 1 0; /* Allows columns to shrink and grow equally */
            min-width: 0; /* Prevents flexbox from overflowing */
        }
        .chord-idx { 
            font-size: clamp(0.7rem, 2vw, 1rem); /* Scales text smoothly */
            color: #fff; 
            font-weight: bold; 
        }
        .chord-dot { 
            width: 100%; 
            max-width: 35px; /* Caps the size on desktop */
            aspect-ratio: 1 / 1; /* Keeps the dot perfectly square */
            height: auto; 
            border-radius: 25%; /* Adjusts border radius to work with fluid sizing */
            border: 2px solid #fff; 
            background: transparent; 
            transition: all 0.2s ease; 
            box-sizing: border-box;
        }
        .chord-dot.active { 
            background: #fff; 
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.6); 
        }
        .chord-note-label { 
            font-size: clamp(0.6rem, 1.8vw, 0.85rem); 
            color: var(--secondary); 
            font-weight: bold; 
            min-height: 18px; 
            text-align: center; 
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Scale Transposer</h1>
    <p class="source-attribution">Source: <a href="https://en.wikipedia.org/wiki/Mode_(music)#Modern_diatonic_modes" target="_blank">Mode (music), Wikipedia</a></p>
    <div class="row">
        <select id="rootNote" onchange="calculateScale()">
            <option value="0">C</option>
            <option value="1">C#</option>
            <option value="2">D</option>
            <option value="3">D#</option>
            <option value="4">E</option>
            <option value="5">F</option>
            <option value="6">F#</option>
            <option value="7">G</option>
            <option value="8">G#</option>
            <option value="9">A</option>
            <option value="10">A#</option>
            <option value="11">B</option>
        </select>
        <button class="preset-btn" onclick="applyPreset([0, 2, 4, 5, 7, 9, 11], 'Ionian (Major)')">Ionian (Major)</button>
        <button class="preset-btn" onclick="applyPreset([0, 2, 3, 5, 7, 9, 10], 'Dorian')">Dorian</button>
        <button class="preset-btn" onclick="applyPreset([0, 1, 3, 5, 7, 8, 10], 'Phrygian')">Phrygian</button>
        <button class="preset-btn" onclick="applyPreset([0, 2, 4, 6, 7, 9, 11], 'Lydian')">Lydian</button>
        <button class="preset-btn" onclick="applyPreset([0, 2, 4, 5, 7, 9, 10], 'Mixolydian')">Mixolydian</button>
        <button class="preset-btn" onclick="applyPreset([0, 2, 3, 5, 7, 8, 10], 'Aeolian (Minor)')">Aeolian (Minor)</button>
        <button class="preset-btn" onclick="applyPreset([0, 1, 3, 5, 6, 8, 10], 'Locrian')">Locrian</button>
    </div>
    <div id="scaleDisplay" style="background:#121212; padding:15px; border-radius:8px; font-size: 1.2rem; text-align: center; letter-spacing: 2px;"></div>
</div>

<div class="container">
    <h1>Chord Relationship Matrix</h1>
    <p style="font-size: 0.9rem; color: #aaa;">Select a chord, emotion, or spectrum. The Scale Transposer will automatically update to show the transition.</p>
    <p class="source-attribution">Source: <a href="https://www.tabletopcomposer.com/post/chord-relationships-and-emotion" target="_blank">Stephen Berkemeier, Tabletop Composer</a></p>
    
    <div class="chord-matrix-container">
        <div class="chord-selectors">
            <div class="input-group">
                <label style="color: var(--accent); font-weight: bold;">Spectrum</label>
                <select id="cr-spectrum" onchange="syncChordData('spectrum')"></select>
            </div>
            
            <div class="input-group">
                <label style="color: var(--secondary); font-weight: bold;">Emotion</label>
                <select id="cr-emotion" onchange="syncChordData('emotion')"></select>
            </div>

            <div class="input-group">
                <label style="color: white; font-weight: bold;">Chord Relationship</label>
                <select id="cr-chord" onchange="syncChordData('chord')"></select>
            </div>
        </div>
        <div id="chordNotesDisplay" class="chord-notes-display"></div>
    </div>
</div>

<div class="container">
    <h1>Chord Dictionary Visualizer</h1>
    <p style="font-size: 0.9rem; color: #aaa;">Explore all standard chord qualities, their interval structures, and how they feel.</p>
    
    <div class="row" style="background: #1f1f1f; padding: 15px; border-radius: 8px; border-left: 4px solid #03dac6; align-items: flex-end;">
        <div class="input-group">
            <label>Root Note</label>
            <select id="dict-root" onchange="renderChordDictionary()"></select>
        </div>
        <div class="input-group">
            <label>Chord Quality</label>
            <select id="dict-quality" onchange="renderChordDictionary()"></select>
        </div>
        <button onclick="playCurrentChord()" style="background: var(--secondary); color: black; padding: 8px 15px; margin-bottom: 2px;">üîä Play Chord</button>
    </div>
    
    <p id="chordDescriptionText" style="text-align: center; font-style: italic; color: #bbb; margin-top: 15px; font-size: 1rem;"></p>
    
    <div id="chordDictVisualizer" class="chord-visualizer"></div>
    <div id="chordDictText" style="margin-top: 20px; font-size: 1.3rem; text-align: center; color: var(--accent); font-weight: bold; letter-spacing: 1px;"></div>
</div>

<div class="container">
    <h1>Time Signature & Rhythm Visualizer</h1>
    <p style="font-size: 0.9rem; color: #aaa;">Enter a time signature to see common accent patterns and visual groupings.</p>
    
    <div class="row" style="background: #1f1f1f; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent);">
        <div class="input-group">
            <label>Beats</label>
            <input type="number" id="ts-num" value="9" min="1" max="32" class="num-md" oninput="updateTimeSignature()">
        </div>
        
        <div style="font-size: 2rem; font-weight: 300; margin: 0 5px; color: #555; align-self: center;">/</div>
        
        <div class="input-group">
            <label>Note Value</label>
            <select id="ts-den" onchange="updateTimeSignature()">
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="8" selected>8</option>
                <option value="16">16</option>
            </select>
        </div>

        <div class="input-group" style="margin-left: 20px; flex: 1; min-width: 200px;">
            <label>Accent Grouping</label>
            <select id="ts-pattern" onchange="renderRhythmVisualization()"></select>
        </div>
    </div>

    <div id="rhythmVisualizer" class="rhythm-visualizer"></div>
</div>

<div class="container">
    <div class="header-row" style="margin-bottom: 15px;">
        <h1>Composite Rhythm Sequencer</h1>
        
        <div class="play-controls">
            <div class="input-group">
                <label>Tempo (BPM)</label>
                <input type="number" id="bpmInput" value="120" style="width: 70px; text-align: center;">
            </div>
            <button id="playBtn" onclick="togglePlay()" style="background: var(--secondary); color: black; font-size: 1.1rem; padding: 10px 20px;">‚ñ∂ Play</button>
        </div>
    </div>

    <div class="instructions">
        <strong>How it works:</strong> This sequencer builds complex patterns by layering simple, repeating rules. 
        <ul>
            <li><strong>Scale Degree:</strong> Chooses which note from your active scale (1st through 7th) the track will trigger.</li>
            <li><strong>Period & Offset:</strong> A track with a Period of 4 and an Offset of 0 pulses on ticks 0, 4, 8, 12. Changing the Offset to 1 shifts it to ticks 1, 5, 9, 13.</li>
            <li><strong>Gate Activators (On/Total/Offset):</strong> These act as rhythmic filters. E.g., setting Gate On to 2 and Gate Total to 4 means the gate is open for 2 ticks, then closed for 2 ticks. A note only plays if its Period pulse hits an open gate.</li>
            <li><strong>Master Gates:</strong> Master Gates act as a global mute. If the master gate is closed, the entire grid is muted for that tick (shown as dim columns).</li>
        </ul>
    </div>

    <div class="header-row" style="background: #1f1f1f; padding: 15px; border-radius: 8px; border-left: 4px solid #cf6679;">
        <div class="input-group">
            <label>Global Resolution (Ticks)</label>
            <input type="number" id="globalRes" value="32" class="num-md" oninput="generate()">
        </div>
        <div class="row" style="margin-bottom: 0;">
            <div class="input-group"><label>Master Gate On</label><input type="number" id="masterOn" value="2" min="1" class="num-sm" oninput="generate()"></div>
            <div class="input-group"><label>Master Gate Total</label><input type="number" id="masterTotal" value="4" min="1" class="num-sm" oninput="generate()"></div>
            <div class="input-group"><label>Master Gate Offset</label><input type="number" id="masterOffset" value="0" min="0" class="num-sm" oninput="generate()"></div>
        </div>
    </div>

    <div class="header-row" style="margin-top: 25px;">
        <h3>Beat Tracks</h3>
        <button onclick="addTrack()" style="background: var(--secondary); color: black;">+ Add Track</button>
    </div>
    <div id="tracksContainer"></div>

    <h3>Step Sequencer Output</h3>
    <div id="rhythmOutput" class="sequencer-grid"></div>
</div>

<script>
    const chromatic = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const allModes = {
        "Ionian (Major)": [0, 2, 4, 5, 7, 9, 11],
        "Dorian": [0, 2, 3, 5, 7, 9, 10],
        "Phrygian": [0, 1, 3, 5, 7, 8, 10],
        "Lydian": [0, 2, 4, 6, 7, 9, 11],
        "Mixolydian": [0, 2, 4, 5, 7, 9, 10],
        "Aeolian (Minor)": [0, 2, 3, 5, 7, 8, 10],
        "Locrian": [0, 1, 3, 5, 6, 8, 10]
    };

    // Brute-forces all 84 standard scales to find exact note matches
    function findMatchingModes(targetNotes) {
        const targetSet = new Set(targetNotes);
        let matches = [];

        for (let rootIdx = 0; rootIdx < 12; rootIdx++) {
            const rootName = chromatic[rootIdx];
            for (const [modeName, modeIntervals] of Object.entries(allModes)) {
                const generatedNotes = modeIntervals.map(s => chromatic[(rootIdx + s) % 12]);
                const generatedSet = new Set(generatedNotes);
                
                // Check if both sets contain the exact same notes
                if (targetSet.size === generatedSet.size && [...targetSet].every(n => generatedSet.has(n))) {
                    matches.push(`${rootName} ${modeName}`);
                }
            }
        }
        return matches.join("  |  ");
    }
    
    // --- Scale Logic ---
    let intervals = [0, 2, 4, 5, 7, 9, 11]; 
    let currentModeName = "Ionian (Major)"; 
    let currentScaleNotes = []; 
    let currentScaleMidi = []; 

    function calculateScale() {
        const root1Index = parseInt(document.getElementById('rootNote').value);
        currentScaleNotes = intervals.map(s => chromatic[(root1Index + s) % 12]);
        currentScaleMidi = intervals.map(s => 60 + root1Index + s); // Middle C = 60

        const primaryRootName = chromatic[root1Index];
        let matches1 = findMatchingModes(currentScaleNotes); // <-- Find matches for source
        
        let displayHtml = `
            <div style="color: var(--secondary); font-weight:bold;">${primaryRootName} ${currentModeName}: ${currentScaleNotes.join(" ‚Äî ")}</div>
            <div style="color: #777; font-size: 0.85rem; margin-top: 8px; font-style: italic; font-weight: normal; letter-spacing: 1px;">
                Relative Modes: ${matches1}
            </div>
        `;

        const crString = document.getElementById('cr-chord').value;
        if (crString) {
            const parts = crString.split(' ');
            if (parts.length === 3) {
                const intSym = parts[1];
                const q2 = parts[2];
                const semitones = intervalMap[intSym] || 0;
                
                const root2Index = (root1Index + semitones) % 12;
                const intervals2 = (q2 === 'M') ? [0, 2, 4, 5, 7, 9, 11] : [0, 2, 3, 5, 7, 8, 10];
                const notes2 = intervals2.map(s => chromatic[(root2Index + s) % 12]);
                const scale2Name = `${chromatic[root2Index]} ${q2 === 'M' ? 'Major' : 'Minor'}`;
                
                let matches2 = findMatchingModes(notes2); // <-- Find matches for translation
                
                displayHtml += `
                    <div style="margin: 15px 0 8px 0; color: #555; font-size: 0.9rem;">‚Üì Translates to ‚Üì</div>
                    <div style="color: var(--accent); font-weight:bold;">${scale2Name}: ${notes2.join(" ‚Äî ")}</div>
                    <div style="color: #777; font-size: 0.85rem; margin-top: 8px; font-style: italic; font-weight: normal; letter-spacing: 1px;">
                        Relative Modes: ${matches2}
                    </div>
                `;
            }
        }

        document.getElementById('scaleDisplay').innerHTML = displayHtml;
        calculateChordNotes(); 
        generate(); 
    }

    function applyPreset(arr, modeName) { 
        intervals = arr; 
        currentModeName = modeName;
        calculateScale(); 
    }

    // --- Chord Relationship Logic ---
    const crData = [
        { chord: "M III m", emotion: "Sadness", spectrum: "Sad" }, { chord: "m IV m", emotion: "Tragic", spectrum: "Sad" },
        { chord: "m V m", emotion: "Tragic", spectrum: "Sad" }, { chord: "m V M", emotion: "Bitter Sweet", spectrum: "Sad" },
        { chord: "m vii M", emotion: "Bitter Sweet", spectrum: "Sad" }, { chord: "M II m", emotion: "Bitter Sweet", spectrum: "Sad" },
        { chord: "m ii m", emotion: "Mysterious and Tense", spectrum: "Evil Sounding" }, { chord: "m VII m", emotion: "Mysterious and Tense", spectrum: "Evil Sounding" },
        { chord: "m VI M", emotion: "Mysterious and Tense", spectrum: "Evil Sounding" }, { chord: "M iii m", emotion: "Mysterious and Tense", spectrum: "Evil Sounding" },
        { chord: "m II m", emotion: "A Little Uneasy", spectrum: "Evil Sounding" }, { chord: "m vii m", emotion: "A Little Uneasy", spectrum: "Evil Sounding" },
        { chord: "m iii m", emotion: "Otherworldly and Ominous", spectrum: "Evil Sounding" }, { chord: "m VI m", emotion: "Otherworldly and Ominous", spectrum: "Evil Sounding" },
        { chord: "m III m", emotion: "Ominous and Dark Sounding", spectrum: "Evil Sounding" }, { chord: "m vi m", emotion: "Ominous and Dark Sounding", spectrum: "Evil Sounding" },
        { chord: "m IV+ m", emotion: "Antagonism and Danger", spectrum: "Evil Sounding" }, { chord: "m VII M", emotion: "Dramatic", spectrum: "Evil/Neutral Sounding" },
        { chord: "M ii m", emotion: "Dramatic", spectrum: "Evil/Neutral Sounding" }, { chord: "m II M", emotion: "Mysterious/Dark comedy", spectrum: "Evil/Neutral Sounding" },
        { chord: "M vii m", emotion: "Mysterious/Dark comedy", spectrum: "Evil/Neutral Sounding" }, { chord: "m IV+ M", emotion: "Outer Space", spectrum: "Evil/Neutral Sounding" },
        { chord: "M IV+ m", emotion: "Outer Space", spectrum: "Evil/Neutral Sounding" }, { chord: "M ii M", emotion: "Exotic/Cowboy/Enchanted Forest", spectrum: "Neutral Sounding" },
        { chord: "M VII M", emotion: "Exotic/Cowboy/Enchanted Forest", spectrum: "Neutral Sounding" }, { chord: "M IV+ M", emotion: "Outer Space (Neutral)", spectrum: "Neutral Sounding" },
        { chord: "M VII m", emotion: "Cautious but Optimistic", spectrum: "Neutral Sounding" }, { chord: "m ii M", emotion: "Cautious but Optimistic", spectrum: "Neutral Sounding" },
        { chord: "m iii M", emotion: "Rising Action/Tension", spectrum: "Neutral Sounding" }, { chord: "m III M", emotion: "Powerful and Mysterious", spectrum: "Neutral Sounding" },
        { chord: "M vi m", emotion: "Powerful and Mysterious", spectrum: "Neutral Sounding" }, { chord: "m vi M", emotion: "Resolution", spectrum: "Neutral Sounding" },
        { chord: "M IV m", emotion: "Romantic/Exotic", spectrum: "Good/Neutral Sounding" }, { chord: "M VI m", emotion: "Other worldly/Heavenly", spectrum: "Good/Neutral Sounding" },
        { chord: "m IV M", emotion: "Wonder and Transcendence", spectrum: "Good/Neutral Sounding" }, { chord: "M V m", emotion: "Wonder and Transcendence", spectrum: "Good/Neutral Sounding" },
        { chord: "M II M", emotion: "Protagonism", spectrum: "Good Sounding" }, { chord: "M vii M", emotion: "Protagonism", spectrum: "Good Sounding" },
        { chord: "M iii M", emotion: "Heroic", spectrum: "Good Sounding" }, { chord: "M VI M", emotion: "Heroic", spectrum: "Good Sounding" },
        { chord: "M III M", emotion: "Fantastical", spectrum: "Good Sounding" }, { chord: "M vi M", emotion: "Fantastical", spectrum: "Good Sounding" },
        { chord: "M IV M", emotion: "Good Energy", spectrum: "Good Sounding" }, { chord: "M V M", emotion: "Good Energy", spectrum: "Good Sounding" }
    ];

    const intervalMap = { "ii": 1, "II": 2, "iii": 3, "III": 4, "IV": 5, "IV+": 6, "V": 7, "vi": 8, "VI": 9, "vii": 10, "VII": 11 };

    function initChordMatrix() {
        const spectrums = [...new Set(crData.map(item => item.spectrum))];
        const emotions = [...new Set(crData.map(item => item.emotion))];
        const chords = [...new Set(crData.map(item => item.chord))];

        const populateSelect = (id, arr) => {
            document.getElementById(id).innerHTML = arr.map(val => `<option value="${val}">${val}</option>`).join('');
        };
        populateSelect('cr-spectrum', spectrums); populateSelect('cr-emotion', emotions); populateSelect('cr-chord', chords);
        syncChordData('chord');
    }

    function syncChordData(sourceField) {
        const spectrumSelect = document.getElementById('cr-spectrum');
        const emotionSelect = document.getElementById('cr-emotion');
        const chordSelect = document.getElementById('cr-chord');

        let targetEntry;
        if (sourceField === 'chord') {
            targetEntry = crData.find(item => item.chord === chordSelect.value);
            if (targetEntry) { emotionSelect.value = targetEntry.emotion; spectrumSelect.value = targetEntry.spectrum; }
        } else if (sourceField === 'emotion') {
            targetEntry = crData.find(item => item.emotion === emotionSelect.value);
            if (targetEntry) { chordSelect.value = targetEntry.chord; spectrumSelect.value = targetEntry.spectrum; }
        } else if (sourceField === 'spectrum') {
            targetEntry = crData.find(item => item.spectrum === spectrumSelect.value);
            if (targetEntry) { chordSelect.value = targetEntry.chord; emotionSelect.value = targetEntry.emotion; }
        }
        calculateScale();
    }

    function calculateChordNotes() {
        const rootIndex = parseInt(document.getElementById('rootNote').value);
        const crString = document.getElementById('cr-chord').value;
        if (!crString) return;

        const parts = crString.split(' ');
        if (parts.length !== 3) return;

        const q1 = parts[0], intSym = parts[1], q2 = parts[2];       
        const semitones = intervalMap[intSym] || 0;
        const root1Index = rootIndex, root2Index = (rootIndex + semitones) % 12;

        const buildChord = (rIdx, quality) => {
            const thirdOffset = (quality === 'M') ? 4 : 3;
            const fifthOffset = 7;
            const rootNote = chromatic[rIdx];
            const thirdNote = chromatic[(rIdx + thirdOffset) % 12];
            const fifthNote = chromatic[(rIdx + fifthOffset) % 12];
            return { name: `${rootNote} ${quality === 'M' ? 'Major' : 'minor'}`, spelling: `${rootNote} - ${thirdNote} - ${fifthNote}` };
        };

        const chord1 = buildChord(root1Index, q1), chord2 = buildChord(root2Index, q2);
        document.getElementById('chordNotesDisplay').innerHTML = `
            <span class="chord-name">${chord1.name}</span> <span class="chord-spelling">(${chord1.spelling})</span>
            <span style="margin: 0 15px; color: white;">‚ûî</span>
            <span class="chord-name">${chord2.name}</span> <span class="chord-spelling">(${chord2.spelling})</span>
        `;
    }

    // --- Rhythm Logic & Sequencer ---
    let tracks = [
        { id: Date.now(), degree: 1, period: 4, offset: 0, actOn: 1, actTotal: 1, actOffset: 0 },
        { id: Date.now()+1, degree: 3, period: 3, offset: 1, actOn: 1, actTotal: 1, actOffset: 0 }
    ];
    let playbackGrid = []; 

    function addTrack() { 
        tracks.push({ id: Date.now(), degree: 1, period: 1, offset: 0, actOn: 1, actTotal: 1, actOffset: 0 }); 
        renderTracks(); 
    }
    
    function removeTrack(id) { 
        tracks = tracks.filter(t => t.id !== id); 
        renderTracks(); 
    }
    
    function updateTrack(id, field, value) { 
        tracks.find(t => t.id === id)[field] = value; 
        generate(); 
    }

    function renderTracks() {
        const container = document.getElementById('tracksContainer');
        container.innerHTML = '';
        tracks.forEach(t => {
            const div = document.createElement('div');
            div.className = 'track-card';
            div.innerHTML = `
                <div class="row">
                    <div class="input-group">
                        <label>Scale Degree</label>
                        <select onchange="updateTrack(${t.id}, 'degree', parseInt(this.value))" style="width:100px; color: var(--accent);">
                            <option value="1" ${t.degree === 1 ? 'selected' : ''}>1 (Root)</option>
                            <option value="2" ${t.degree === 2 ? 'selected' : ''}>2nd</option>
                            <option value="3" ${t.degree === 3 ? 'selected' : ''}>3rd</option>
                            <option value="4" ${t.degree === 4 ? 'selected' : ''}>4th</option>
                            <option value="5" ${t.degree === 5 ? 'selected' : ''}>5th</option>
                            <option value="6" ${t.degree === 6 ? 'selected' : ''}>6th</option>
                            <option value="7" ${t.degree === 7 ? 'selected' : ''}>7th</option>
                        </select>
                    </div>
                    <div class="input-group"><label>Period</label><input type="number" value="${t.period}" min="1" oninput="updateTrack(${t.id}, 'period', parseInt(this.value) || 1)" class="num-sm"></div>
                    <div class="input-group"><label>Offset</label><input type="number" value="${t.offset}" min="0" oninput="updateTrack(${t.id}, 'offset', parseInt(this.value) || 0)" class="num-sm"></div>
                    
                    <div style="width: 2px; background: #444; margin: 0 5px; height: 40px; align-self: center;"></div>
                    
                    <div class="input-group"><label>Gate On</label><input type="number" value="${t.actOn}" min="1" oninput="updateTrack(${t.id}, 'actOn', parseInt(this.value) || 1)" class="num-sm"></div>
                    <div class="input-group"><label>Gate Total</label><input type="number" value="${t.actTotal}" min="1" oninput="updateTrack(${t.id}, 'actTotal', parseInt(this.value) || 1)" class="num-sm"></div>
                    <div class="input-group"><label>Gate Offset</label><input type="number" value="${t.actOffset}" min="0" oninput="updateTrack(${t.id}, 'actOffset', parseInt(this.value) || 0)" class="num-sm"></div>
                    
                    <button onclick="removeTrack(${t.id})" style="background:#cf6679; margin-left: auto;">√ó</button>
                </div>
            `;
            container.appendChild(div);
        });
        generate();
    }

    function checkGate(tick, on, total, offset) {
        if (!total || total <= 0) return true;
        const pos = (tick + (offset || 0)) % total;
        return pos < on;
    }

    function generate() {
        const res = parseInt(document.getElementById('globalRes').value) || 16;
        
        const mOn = parseInt(document.getElementById('masterOn').value) || 1;
        const mTotal = parseInt(document.getElementById('masterTotal').value) || 1;
        const mOff = parseInt(document.getElementById('masterOffset').value) || 0;
        
        const output = document.getElementById('rhythmOutput');
        playbackGrid = Array.from({length: res}, () => []);

        let html = '<div class="tick-ruler">';
        for(let i=0; i<res; i++) html += `<div class="tick-label" data-tick="${i}">${i}</div>`;
        html += '</div>';

        for (let degree = 7; degree >= 1; degree--) {
            const noteName = currentScaleNotes[degree - 1] || "?"; 
            html += `<div class="seq-row"><div class="seq-label" title="Degree ${degree}">${noteName}</div>`;
            
            for (let i = 0; i < res; i++) {
                const isMasterOn = checkGate(i, mOn, mTotal, mOff);
                let isNoteTriggered = false;

                tracks.forEach(t => {
                    if (t.degree === degree && (i - t.offset) % t.period === 0 && i >= t.offset && checkGate(i, t.actOn, t.actTotal, t.actOffset)) {
                        isNoteTriggered = true;
                    }
                });

                const active = isMasterOn && isNoteTriggered;
                let cellClass = `seq-cell`;
                if (!isMasterOn) cellClass += ' master-off';
                else if (active) {
                    cellClass += ' on';
                    const midiNote = currentScaleMidi[degree - 1];
                    const freq = 440 * Math.pow(2, (midiNote - 69) / 12);
                    playbackGrid[i].push(freq);
                }

                html += `<div class="${cellClass}" data-tick="${i}">${active ? '‚ô™' : ''}</div>`;
            }
            html += `</div>`;
        }
        output.innerHTML = html;
    }

    // --- Web Audio API Engine ---
    let audioCtx = null;
    let isPlaying = false;
    let currentTick = 0;
    let nextNoteTime = 0;
    let timerID;

    function togglePlay() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        isPlaying = !isPlaying;
        const btn = document.getElementById('playBtn');
        
        if (isPlaying) {
            btn.innerHTML = '‚èπ Stop';
            btn.style.background = '#cf6679';
            currentTick = 0;
            nextNoteTime = audioCtx.currentTime + 0.05;
            schedule();
        } else {
            btn.innerHTML = '‚ñ∂ Play';
            btn.style.background = 'var(--secondary)';
            clearTimeout(timerID);
            updatePlayheadUI(-1); 
        }
    }

    function schedule() {
        const bpm = parseInt(document.getElementById('bpmInput').value) || 120;
        const secondsPerTick = (60.0 / bpm) / 4; 
        const res = parseInt(document.getElementById('globalRes').value) || 16;

        while (nextNoteTime < audioCtx.currentTime + 0.1) {
            playTick(currentTick, nextNoteTime, secondsPerTick);
            
            const timeToPlay = (nextNoteTime - audioCtx.currentTime) * 1000;
            const tickToHighlight = currentTick;
            setTimeout(() => updatePlayheadUI(tickToHighlight), timeToPlay);
            
            currentTick = (currentTick + 1) % res;
            nextNoteTime += secondsPerTick;
        }
        timerID = setTimeout(schedule, 25);
    }

    function playTick(tick, time, duration) {
        if (!playbackGrid[tick] || playbackGrid[tick].length === 0) return;
        
        playbackGrid[tick].forEach(freq => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine'; 
            osc.frequency.setValueAtTime(freq, time);
            
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(0.2, time + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration - 0.01);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(time);
            osc.stop(time + duration);
        });
    }

    function updatePlayheadUI(tick) {
        document.querySelectorAll('.seq-cell.playing, .tick-label.playing').forEach(el => el.classList.remove('playing'));
        if (tick >= 0) {
            document.querySelectorAll(`.seq-cell[data-tick="${tick}"], .tick-label[data-tick="${tick}"]`).forEach(el => el.classList.add('playing'));
        }
    }

    // --- Time Signature & Rhythm Logic ---
    const commonGroupings = {
        2: ["2", "1+1"],
        3: ["3", "1+1+1"],
        4: ["4", "2+2", "3+1", "1+3"],
        5: ["3+2", "2+3"],
        6: ["3+3", "2+2+2"],
        7: ["3+2+2", "2+3+2", "2+2+3"],
        8: ["3+3+2", "2+3+3", "3+2+3", "2+2+2+2", "4+4"],
        9: ["3+3+3", "2+2+2+3", "2+2+3+2", "2+3+2+2", "3+2+2+2"],
        10: ["3+3+2+2", "3+2+2+3", "2+2+3+3", "2+3+3+2"],
        11: ["3+3+3+2", "3+3+2+3", "3+2+3+3", "2+3+3+3"],
        12: ["3+3+3+3", "4+4+4", "2+2+2+2+2+2"]
    };

    function updateTimeSignature() {
        const num = parseInt(document.getElementById('ts-num').value) || 4;
        const patternSelect = document.getElementById('ts-pattern');
        
        let options = [];
        if (commonGroupings[num]) {
            options = commonGroupings[num];
        } else {
            // Fallback for uncommon numerators
            options = [num.toString(), Array(num).fill(1).join('+')];
        }
        
        patternSelect.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        renderRhythmVisualization();
    }

    function renderRhythmVisualization() {
        const num = parseInt(document.getElementById('ts-num').value) || 4;
        const den = document.getElementById('ts-den').value;
        const patternStr = document.getElementById('ts-pattern').value;
        const container = document.getElementById('rhythmVisualizer');
        
        const groups = patternStr.split('+').map(Number);
        
        let html = '';
        let beatCount = 1;
        
        // Define note symbol based on denominator
        let noteSymbol = '‚ô©'; // Default to quarter note
        if (den === '2') noteSymbol = 'ùÖóùÖ•'; // Half note
        if (den === '8') noteSymbol = '‚ô™'; // Eighth note
        if (den === '16') noteSymbol = 'ùÖòùÖ•ùÖØ'; // Sixteenth note
        
        groups.forEach((groupSize) => {
            html += `<div class="rhythm-group">`;
            for (let i = 0; i < groupSize; i++) {
                const isAccent = (i === 0);
                html += `
                    <div class="rhythm-block ${isAccent ? 'accent' : ''}" title="Beat ${beatCount}">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <span style="font-size: 0.7rem; margin-bottom: -4px;">${beatCount}</span>
                            <span>${noteSymbol}</span>
                        </div>
                    </div>
                `;
                beatCount++;
            }
            html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    // --- Chord Dictionary Logic ---
// --- Chord Dictionary Logic ---
const extendedChords = {
        "Major": { intervals: [0, 4, 7], desc: "Happy, stable, and resolved. The foundation of Western music." },
        "Major Sixth": { intervals: [0, 4, 7, 9], desc: "Warm, playful, and sweet. Often used in vintage pop and Hawaiian music." },
        "Major Seventh": { intervals: [0, 4, 7, 11], desc: "Lush, dreamy, and romantic. Very common in jazz and lo-fi." },
        "Minor": { intervals: [0, 3, 7], desc: "Sad, melancholic, and serious." },
        "Minor Sixth": { intervals: [0, 3, 7, 9], desc: "Mysterious and dark, often associated with spy films or noir soundtracks." },
        "Minor Seventh": { intervals: [0, 3, 7, 10], desc: "Smooth, mellow, and slightly mournful. A staple of R&B and jazz." },
        "Diminished": { intervals: [0, 3, 6], desc: "Tense, spooky, and highly unstable. Sounds like impending danger." },
        "Diminished Seventh": { intervals: [0, 3, 6, 9], desc: "Dramatic, suspenseful, and classic horror-villain music." },
        "Half-Diminished": { intervals: [0, 3, 6, 10], desc: "Tragic and wandering. Common in deeply emotional, romantic progressions." },
        "Augmented": { intervals: [0, 4, 8], desc: "Floating, dream-like, and ambiguous. Sounds like stepping into a magical portal." },
        "Aug. Seventh": { intervals: [0, 4, 8, 10], desc: "Highly tense and pulling, forcefully pushing the listener toward a resolution." },
        "Aug. Maj. Seventh": { intervals: [0, 4, 8, 11], desc: "Complex, highly dissonant but lush. Often sounds sci-fi or otherworldly." },
        "Dominant Seventh": { intervals: [0, 4, 7, 10], desc: "Bluesy, energetic, and restless. Strongly wants to resolve to a major chord." },
        "Suspended 2": { intervals: [0, 2, 7], desc: "Open, airy, and hopeful. Lacks the definitive emotion of a Major/Minor 3rd." },
        "Suspended 4": { intervals: [0, 5, 7], desc: "Unresolved and floating. Feels like it's holding its breath before resolving." },
        "Power": { intervals: [0, 7], desc: "Strong, neutral, and punchy. The driving backbone of rock and heavy metal." }
    };

    function initChordDictionary() {
        const rootSelect = document.getElementById('dict-root');
        rootSelect.innerHTML = chromatic.map((note, i) => `<option value="${i}">${note}</option>`).join('');
        
        const qualitySelect = document.getElementById('dict-quality');
        qualitySelect.innerHTML = Object.keys(extendedChords).map(q => `<option value="${q}">${q}</option>`).join('');
        
        renderChordDictionary();
    }

    function renderChordDictionary() {
        const rootIdx = parseInt(document.getElementById('dict-root').value);
        const quality = document.getElementById('dict-quality').value;
        const chordData = extendedChords[quality];
        const intervals = chordData.intervals;
        
        let html = '';
        let spelling = [];
        
        for(let i = 0; i <= 11; i++) {
            const isActive = intervals.includes(i);
            let noteName = '';
            
            if(isActive) {
                noteName = chromatic[(rootIdx + i) % 12];
                spelling.push(noteName);
            }
            
            html += `
                <div class="chord-col">
                    <div class="chord-idx">${i}</div>
                    <div class="chord-dot ${isActive ? 'active' : ''}"></div>
                    <div class="chord-note-label">${noteName}</div>
                </div>
            `;
        }
        
        document.getElementById('chordDictVisualizer').innerHTML = html;
        document.getElementById('chordDictText').innerText = `${chromatic[rootIdx]} ${quality}: ${spelling.join(' - ')}`;
        document.getElementById('chordDescriptionText').innerText = `"${chordData.desc}"`;
    }

    function playCurrentChord() {
        // Initialize Web Audio API if not already running
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const rootIdx = parseInt(document.getElementById('dict-root').value);
        const quality = document.getElementById('dict-quality').value;
        const intervals = extendedChords[quality].intervals;

        const time = audioCtx.currentTime;
        const duration = 2.0; // Let the chord ring out for 2 seconds

        intervals.forEach(interval => {
            const midiNote = 60 + rootIdx + interval; // Start at Middle C (60)
            const freq = 440 * Math.pow(2, (midiNote - 69) / 12);

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            // Using a triangle wave for chords as it sounds softer and more electric-piano-like than sine waves
            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(freq, time);

            // Volume Envelope: Quick attack, smooth fade out
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(0.15, time + 0.05); 
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration); 

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start(time);
            osc.stop(time + duration);
        });
    }

    // Init App
    initChordMatrix();
    initChordDictionary();
    renderTracks();
    updateTimeSignature();
</script>
</body>
</html>