<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theory Tool - Composite Rhythms</title>
    <style>
        :root {
            --bg: #1a1a1a; --card: #2d2d2d; --text: #e0e0e0;
            --accent: #bb86fc; --secondary: #03dac6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 900px; width: 100%; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        input, select, textarea { background: #3d3d3d; border: 1px solid #555; color: white; padding: 6px; border-radius: 4px; }
        button { background: var(--accent); color: black; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .track-card { background: #1f1f1f; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--secondary); }
        .rhythm-visualizer { display: flex; gap: 3px; margin-top: 15px; flex-wrap: wrap; background: #000; padding: 10px; border-radius: 4px; }
        .beat-cell { width: 22px; height: 22px; border-radius: 2px; font-size: 0.6rem; display: flex; align-items: center; justify-content: center; }
        .on { background: var(--secondary); color: black; box-shadow: 0 0 5px var(--secondary); }
        .off { background: #333; color: #666; }
        .master-off { border: 1px solid #cf6679; opacity: 0.3; }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>Scale Transposer</h1>
    <div class="row">
        <select id="rootNote" onchange="calculateScale()">
	    <option value="0">C</option>
	    <option value="1">C#</option>
	    <option value="2">D</option>
	    <option value="3">D#</option>
	    <option value="4">E</option>
	    <option value="5">F</option>
	    <option value="6">F#</option>
	    <option value="7">G</option>
	    <option value="8">G#</option>
	    <option value="9">A</option>
	    <option value="10">A#</option>
	    <option value="11">B</option>
	</select>
	<button onclick="applyPreset([0, 2, 4, 5, 7, 9, 11])">Ionian (Major)</button>
        <button onclick="applyPreset([0, 2, 3, 5, 7, 9, 10])">Dorian</button>
        <button onclick="applyPreset([0, 1, 3, 5, 7, 8, 10])">Phrygian</button>
        <button onclick="applyPreset([0, 2, 4, 6, 7, 9, 11])">Lydian</button>
        <button onclick="applyPreset([0, 2, 4, 5, 7, 9, 10])">Mixolydian</button>
        <button onclick="applyPreset([0, 2, 3, 5, 7, 8, 10])">Aeolian (Minor)</button>
        <button onclick="applyPreset([0, 1, 3, 5, 6, 8, 10])">Locrian</button>
    </div>
    <div id="scaleDisplay" style="background:#121212; padding:15px; border-radius:8px;"></div>
</div>

<div class="container">
    <div class="header-row">
        <h1>Composite Rhythm Generator</h1>
        <div class="input-group">
            <label>Global Resolution (Ticks)</label>
            <input type="number" id="globalRes" value="32" style="width: 60px;" oninput="generate()">
        </div>
    </div>

    <h3>1. Master Activators</h3>
    <p style="font-size: 0.8rem; color: #aaa;">Notes only play if these cycles are "On". Format: On/Total/Offset (e.g., 2/4/0)</p>
    <p style="font-size: 0.8rem; color: #aaa;">On = Pulse Width = How many consecutive ticks the gate stays "open."</p>
    <p style="font-size: 0.8rem; color: #aaa;">Total = Cycle Length = The total length of the loop before it repeats.</p>
    <p style="font-size: 0.8rem; color: #aaa;">Offset = Phase Shift = Shifting the starting point of the loop (Syncopation).</p>
    <div id="masterActivators" class="row">
        <input type="text" id="masterInput" value="2/4/0" placeholder="2/4/0 1/8/2">
        <button onclick="generate()">Apply Master</button>
    </div>

    <div class="header-row">
        <h3>2. Beat Tracks</h3>
        <button onclick="addTrack()" class="preset-btn">+ Add Track</button>
    </div>
    <div id="tracksContainer"></div>

    <h3>Output Visualizer</h3>
    <div id="rhythmOutput" class="rhythm-visualizer"></div>
</div>

<script>
    // --- Scale Logic (Simplified for brevity) ---
    const chromatic = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    // Default to C Major
    let intervals = [0, 2, 4, 5, 7, 9, 11];
    function calculateScale() {
        const root = parseInt(document.getElementById('rootNote').value);
        const notes = intervals.map(s => chromatic[(root + s) % 12]);
        document.getElementById('scaleDisplay').innerText = notes.join(" — ");
    }
    function applyPreset(arr) { intervals = arr; calculateScale(); }

    // --- Rhythm Logic ---
    let tracks = [{ id: Date.now(), period: 4, offset: 0, activators: "1/1/0" }];

    function addTrack() {
        tracks.push({ id: Date.now(), period: 1, offset: 0, activators: "1/1/0" });
        renderTracks();
    }

    function removeTrack(id) {
        tracks = tracks.filter(t => t.id !== id);
        renderTracks();
    }

    function updateTrack(id, field, value) {
        const track = tracks.find(t => t.id === id);
        track[field] = value;
        generate();
    }

    function renderTracks() {
        const container = document.getElementById('tracksContainer');
        container.innerHTML = '';
        tracks.forEach(t => {
            const div = document.createElement('div');
            div.className = 'track-card';
            div.innerHTML = `
                <div class="row">
                    <div class="input-group"><label>Period</label><input type="number" value="${t.period}" oninput="updateTrack(${t.id}, 'period', parseInt(this.value))" style="width:50px"></div>
                    <div class="input-group"><label>Offset</label><input type="number" value="${t.offset}" oninput="updateTrack(${t.id}, 'offset', parseInt(this.value))" style="width:50px"></div>
                    <div class="input-group"><label>Track Activators (On/Total/Offset)</label><input type="text" value="${t.activators}" oninput="updateTrack(${t.id}, 'activators', this.value)" style="width:200px"></div>
                    <button onclick="removeTrack(${t.id})" style="background:#cf6679">×</button>
                </div>
            `;
            container.appendChild(div);
        });
        generate();
    }

    function checkActivator(tick, str) {
        if (!str.trim()) return true;
        const cycles = str.trim().split(/\s+/);
        return cycles.every(c => {
            const [on, total, offset] = c.split('/').map(Number);
            const pos = (tick + (offset || 0)) % total;
            return pos < on;
        });
    }

    function generate() {
        const res = parseInt(document.getElementById('globalRes').value);
        const masterStr = document.getElementById('masterInput').value;
        const output = document.getElementById('rhythmOutput');
        output.innerHTML = '';

        for (let i = 0; i < res; i++) {
            const isMasterOn = checkActivator(i, masterStr);
            let isNoteTriggered = false;

            tracks.forEach(t => {
                // Check if tick hits the period pulse
                if ((i - t.offset) % t.period === 0 && i >= t.offset) {
                    // Check if track's internal activators allow it
                    if (checkActivator(i, t.activators)) {
                        isNoteTriggered = true;
                    }
                }
            });

            const active = isMasterOn && isNoteTriggered;
            const cell = document.createElement('div');
            cell.className = `beat-cell ${active ? 'on' : 'off'} ${!isMasterOn ? 'master-off' : ''}`;
            cell.innerText = i;
            output.appendChild(cell);
        }
    }

    // Init
    calculateScale();
    renderTracks();
</script>
</body>
</html>
